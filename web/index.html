<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ä»£ç å®‰å…¨åˆ†æç³»ç»Ÿ</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 30px 0; }
        header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        header p { color: #888; font-size: 1rem; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .panel h2 { font-size: 1.1rem; margin-bottom: 15px; color: #00d4ff; }
        textarea {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 12px;
            color: #e0e0e0;
            font-family: 'Consolas', 'Fira Code', monospace;
            font-size: 13px;
            resize: vertical;
            min-height: 300px;
        }
        textarea:focus { outline: none; border-color: #00d4ff; }
        .btn-group { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(90deg, #ff6b6b, #ee5a24);
            color: white;
        }
        .btn-success {
            background: linear-gradient(90deg, #00b894, #00cec9);
            color: white;
        }
        .btn-primary:hover, .btn-danger:hover, .btn-success:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 20px rgba(0,212,255,0.3); 
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #e0e0e0;
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        .result-panel {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            max-height: 450px;
            overflow-y: auto;
        }
        .result-panel pre {
            white-space: pre-wrap;
            word-break: break-word;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .status { padding: 10px; border-radius: 6px; margin-top: 10px; }
        .status.success { background: rgba(0,255,100,0.2); color: #00ff64; }
        .status.error { background: rgba(255,50,50,0.2); color: #ff5050; }
        .status.loading { background: rgba(255,200,0,0.2); color: #ffc800; }
        select {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: #e0e0e0;
            margin-bottom: 10px;
        }
        .summary-box {
            background: rgba(0,212,255,0.1);
            border-left: 4px solid #00d4ff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }
        .suggestion-item {
            padding: 10px 12px;
            margin: 5px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            font-size: 13px;
            border-left: 3px solid #ffc800;
        }
        .fixed-code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success { background: rgba(0,184,148,0.3); color: #00b894; }
        .badge-danger { background: rgba(255,107,107,0.3); color: #ff6b6b; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ›¡ï¸ æ™ºèƒ½ä»£ç å®‰å…¨åˆ†æç³»ç»Ÿ</h1>
            <p>åŸºäºAIæ™ºèƒ½ä½“çš„ä»£ç æ¼æ´æ£€æµ‹ä¸è‡ªåŠ¨ä¿®å¤å¹³å°</p>
        </header>

        <div class="main-grid">
            <div class="panel">
                <h2>ğŸ“ è¾“å…¥å¾…æ£€æµ‹ä»£ç </h2>
                <label style="color:#888;font-size:13px;">ç¼–ç¨‹è¯­è¨€:</label>
                <select id="language">
                    <option value="c">C è¯­è¨€</option>
                    <option value="cpp">C++ è¯­è¨€</option>
                    <option value="python">Python</option>
                </select>
                <textarea id="code" placeholder="åœ¨æ­¤ç²˜è´´æ‚¨è¦æ£€æµ‹çš„ä»£ç ...">#include <stdio.h>
#include <string.h>
#include <stdlib.h>

// ç¤ºä¾‹ï¼šå­˜åœ¨å®‰å…¨æ¼æ´çš„ä»£ç 
void process_input(char *user_input) {
    char buffer[64];
    // å±é™©ï¼šæ²¡æœ‰é•¿åº¦æ£€æŸ¥ï¼Œå¯èƒ½å¯¼è‡´ç¼“å†²åŒºæº¢å‡º
    strcpy(buffer, user_input);
    printf("å¤„ç†: %s\n", buffer);
}

int parse_number(const char *str) {
    // å±é™©ï¼šæ²¡æœ‰æ£€æŸ¥ç©ºæŒ‡é’ˆ
    return atoi(str);
}

char* read_file(const char *filename) {
    FILE *f = fopen(filename, "r");
    // å±é™©ï¼šæ²¡æœ‰æ£€æŸ¥fopenè¿”å›å€¼
    char *buf = malloc(1024);
    fread(buf, 1, 1024, f);
    fclose(f);
    return buf;  // æ½œåœ¨å†…å­˜æ³„æ¼é£é™©
}</textarea>
                
                <div class="btn-group">
                    <button class="btn-danger" onclick="securityAnalysis()" title="AIåˆ†æä»£ç å®‰å…¨é—®é¢˜å¹¶è‡ªåŠ¨ç”Ÿæˆä¿®å¤ä»£ç ">
                        ğŸ” ä¸€é”®å®‰å…¨åˆ†æ
                    </button>
                    <button class="btn-secondary" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
                
                <div id="status"></div>
            </div>

            <div class="panel">
                <h2>ğŸ“Š åˆ†æç»“æœ</h2>
                <div id="summary-section" style="display:none;">
                    <div class="summary-box" id="summary-box"></div>
                </div>
                <div id="suggestions-section" style="display:none;">
                    <h3 style="font-size:0.95rem;margin-bottom:10px;color:#ffc800;">ğŸ’¡ ä¿®å¤å»ºè®®</h3>
                    <div id="suggestions-list"></div>
                </div>
                <div class="result-panel">
                    <pre id="result">ç‚¹å‡»ã€Œä¸€é”®å®‰å…¨åˆ†æã€æŒ‰é’®ï¼Œç³»ç»Ÿå°†ï¼š
1. è‡ªåŠ¨æ£€æµ‹ä»£ç ä¸­çš„å®‰å…¨æ¼æ´
2. åˆ†ææ½œåœ¨çš„é£é™©é—®é¢˜
3. ç”Ÿæˆä¿®å¤åçš„å®‰å…¨ä»£ç </pre>
                </div>
            </div>
        </div>

        <div class="panel" style="margin-top:20px;">
            <div class="fixed-code-header">
                <h2>âœ¨ ä¿®å¤åçš„ä»£ç </h2>
                <span class="badge badge-success" id="fix-badge" style="display:none;">å·²è‡ªåŠ¨ä¿®å¤</span>
            </div>
            <div class="result-panel" style="max-height:500px;">
                <pre id="fixed-code-result">åˆ†æå®Œæˆåï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆä¿®å¤åçš„å®‰å…¨ä»£ç </pre>
            </div>
            <div class="btn-group">
                <button class="btn-success" onclick="copyFixedCode()">ğŸ“‹ å¤åˆ¶ä¿®å¤ä»£ç </button>
                <button class="btn-secondary" onclick="downloadFixedCode()">ğŸ’¾ ä¸‹è½½æ–‡ä»¶</button>
                <button class="btn-secondary" onclick="applyFix()">ğŸ”„ åº”ç”¨åˆ°å·¦ä¾§</button>
            </div>
        </div>
    </div>

    <script>
        // APIåœ°å€é…ç½®
        // æœ¬åœ°å¼€å‘: http://127.0.0.1:8000/api
        // çº¿ä¸Šéƒ¨ç½²: è‡ªåŠ¨æ£€æµ‹æˆ–æ‰‹åŠ¨è®¾ç½®
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://127.0.0.1:8000/api'
            : window.location.origin + '/api';
        let currentFixedCode = '';

        function setStatus(message, type) {
            const status = document.getElementById('status');
            status.className = 'status ' + type;
            status.textContent = message;
        }

        // ä¸€é”®å®‰å…¨åˆ†æ
        async function securityAnalysis() {
            const code = document.getElementById('code').value;
            const language = document.getElementById('language').value;
            
            if (!code.trim()) {
                setStatus('è¯·è¾“å…¥ä»£ç ', 'error');
                return;
            }
            
            setStatus('ğŸ”„ æ­£åœ¨è¿›è¡Œå®‰å…¨åˆ†æ...', 'loading');
            document.getElementById('result').textContent = 'åˆ†æä¸­ï¼Œè¯·ç¨å€™...\n\nâ³ æ­¥éª¤1: ä»£ç ç»“æ„åˆ†æ\nâ³ æ­¥éª¤2: å®‰å…¨æ¼æ´æ£€æµ‹\nâ³ æ­¥éª¤3: ç”Ÿæˆä¿®å¤ä»£ç ';
            document.getElementById('fixed-code-result').textContent = 'æ­£åœ¨ç”Ÿæˆä¿®å¤ä»£ç ...';
            document.getElementById('fix-badge').style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/analyze/security`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, language })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'åˆ†æå¤±è´¥');
                }
                
                const data = await response.json();
                
                // æ˜¾ç¤ºæ€»ç»“
                if (data.summary) {
                    document.getElementById('summary-section').style.display = 'block';
                    document.getElementById('summary-box').innerHTML = `<strong>ğŸ“‹ åˆ†ææ€»ç»“</strong><br>${data.summary}`;
                }
                
                // æ˜¾ç¤ºå»ºè®®
                if (data.suggestions && data.suggestions.length > 0) {
                    document.getElementById('suggestions-section').style.display = 'block';
                    document.getElementById('suggestions-list').innerHTML = data.suggestions
                        .map(s => `<div class="suggestion-item">${s}</div>`).join('');
                }
                
                // æ˜¾ç¤ºè¯¦ç»†åˆ†æ
                if (data.security_analysis) {
                    document.getElementById('result').textContent = data.security_analysis;
                }
                
                // æ˜¾ç¤ºä¿®å¤åçš„ä»£ç 
                if (data.fixed_code) {
                    currentFixedCode = data.fixed_code;
                    document.getElementById('fixed-code-result').textContent = data.fixed_code;
                    document.getElementById('fix-badge').style.display = 'inline-block';
                } else {
                    document.getElementById('fixed-code-result').textContent = 'æœªå‘ç°éœ€è¦ä¿®å¤çš„é—®é¢˜ï¼Œæˆ–æ— æ³•è‡ªåŠ¨ç”Ÿæˆä¿®å¤ä»£ç ';
                }
                
                const vulnCount = data.vulnerabilities?.length || 0;
                if (vulnCount > 0) {
                    setStatus(`âœ… åˆ†æå®Œæˆï¼å‘ç° ${vulnCount} ä¸ªé—®é¢˜ï¼Œå·²ç”Ÿæˆä¿®å¤ä»£ç `, 'success');
                } else {
                    setStatus('âœ… åˆ†æå®Œæˆï¼æœªå‘ç°æ˜æ˜¾å®‰å…¨é—®é¢˜', 'success');
                }
                
            } catch (error) {
                setStatus('âŒ ' + error.message, 'error');
                document.getElementById('result').textContent = 'é”™è¯¯: ' + error.message;
            }
        }

        function copyFixedCode() {
            if (currentFixedCode) {
                navigator.clipboard.writeText(currentFixedCode);
                setStatus('å·²å¤åˆ¶ä¿®å¤ä»£ç åˆ°å‰ªè´´æ¿', 'success');
            } else {
                setStatus('æ²¡æœ‰å¯å¤åˆ¶çš„ä»£ç ', 'error');
            }
        }

        function downloadFixedCode() {
            if (currentFixedCode) {
                const language = document.getElementById('language').value;
                const ext = {c: 'c', cpp: 'cpp', python: 'py'}[language] || 'txt';
                const blob = new Blob([currentFixedCode], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fixed_code.${ext}`;
                a.click();
                URL.revokeObjectURL(url);
                setStatus('æ–‡ä»¶ä¸‹è½½ä¸­...', 'success');
            } else {
                setStatus('æ²¡æœ‰å¯ä¸‹è½½çš„ä»£ç ', 'error');
            }
        }

        function applyFix() {
            if (currentFixedCode) {
                document.getElementById('code').value = currentFixedCode;
                setStatus('å·²å°†ä¿®å¤ä»£ç åº”ç”¨åˆ°è¾“å…¥æ¡†', 'success');
            } else {
                setStatus('æ²¡æœ‰å¯åº”ç”¨çš„ä¿®å¤ä»£ç ', 'error');
            }
        }

        function clearAll() {
            document.getElementById('code').value = '';
            document.getElementById('result').textContent = 'ç‚¹å‡»ã€Œä¸€é”®å®‰å…¨åˆ†æã€æŒ‰é’®ï¼Œç³»ç»Ÿå°†ï¼š\n1. è‡ªåŠ¨æ£€æµ‹ä»£ç ä¸­çš„å®‰å…¨æ¼æ´\n2. åˆ†ææ½œåœ¨çš„é£é™©é—®é¢˜\n3. ç”Ÿæˆä¿®å¤åçš„å®‰å…¨ä»£ç ';
            document.getElementById('fixed-code-result').textContent = 'åˆ†æå®Œæˆåï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆä¿®å¤åçš„å®‰å…¨ä»£ç ';
            document.getElementById('summary-section').style.display = 'none';
            document.getElementById('suggestions-section').style.display = 'none';
            document.getElementById('fix-badge').style.display = 'none';
            document.getElementById('status').className = '';
            document.getElementById('status').textContent = '';
            currentFixedCode = '';
        }
    </script>
</body>
</html>
